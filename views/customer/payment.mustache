<!-- Purpose: To let user define and update their payment information -->
{{>header}}

<h3>Payment</h3>

<form action="/customer/payment" method="POST" id="customer-payment-form">
  <div class="plans callout grid-x grid-margin-x grid-padding-x">
    {{#plans}}
      <div class="cell small-4 text-center plan-column" data-plan-id="{{ name }}">
        <div class="plan-label">
          <h4>{{ label }}</h4>
        </div>

        <div class="plan-select text-center">
          <button type="button" id="plan_select_{{ name }}" class="plan-select-button button">Select {{ label }}</button>
        </div>
      </div>
    {{/plans}}

    <input type="hidden" id="selected_plan" name="selected-plan" value="">
    <input type="hidden" id="stripe_token" name="stripe-token" value="">
  </div>

  <div class="payment callout">

    <label for="card-element">
      Credit or debit card
    </label>

    <div id="card-element"></div>

    <div id="card-errors" role="alert"></div>

  </div>

  <div class="actions">
    <button type="button" id="pay" class="button">Pay</button>
  </div>
</form>

<style>
.plan-column {
  height: 300px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  border: 1px solid rgba(0, 0, 0, 0);
  cursor: pointer;
}

.plan-column.selected {
  background: rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(0, 0, 0, 0.2);
}
</style>

<script>

  // Initialize Stripe

  function init_stripe() {
    var stripe = Stripe('pk_test_51HkBW2IwNv8toLXhpH9lwN5KlAxyLD71OaaXdTzLR8S68uSGUPWHvucLGzQJhujdI7hAgKbmk4S4nssnuzPfP6vW00BVVW9Knr');
    var elements = stripe.elements();
    var cardElement = elements.create('card');
    cardElement.mount('#card-element');
  }

  function init_events() {
    //  Clicking a plan
    $(document).on('click', '.plan-column', function(evt) {
      $('.plan-column').removeClass('selected');
      $(this).addClass('selected');

      let plan_id = $(this).data('plan-id');
      $('#selected_plan').val(plan_id);
    });

    let $form = $('#customer-payment-form');
    $form.on('submit', function(evt) {
      evt.preventDefault();
      stripe.createToken(cardElement)
        .then(function(result) {
          if(result.error) {
            $('#card-errors').text(result.error.message);
          } else {
            create_token(result.token);
          }
        })
      return false;
    });
  }

  function create_token(token) {
    let $form = $('#customer-payment-form');
    let $stripe_token = $('#stripe_token');
    $stripe_token.val(token);
    $form.submit();
  }
</script>

{{>footer}}